package org.example;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.sql.*;
import java.time.Duration;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

public class AnyFiveActiviesCrawler_plus {

    private static final String WEB_DRIVER_ID = "webdriver.chrome.driver";
    private static final String WEB_DRIVER_PATH = "C:/Users/LEEJUHWAN/Downloads/chromedriver-win64/chromedriver-win64/chromedriver.exe"; // ★★★ 이 부분을 수정해야 함 ★★★

    private static final String USER_ID = "master";
    private static final String USER_PW = "five4190any#";
    private static final String TARGET_URL = "https://auth.onnet21.com/?re=anyfive.onnet21.com/sso/login";
    private static final String IFRAME_NAME = "content_frame"; // 게시판 콘텐츠 Iframe 이름

    // ★★★ MariaDB 연결 정보 ★★★
    private static final String DB_URL = "jdbc:mariadb://localhost:3306/any_approval"; // DB 주소 및 스키마
    private static final String DB_USER = "root";       // 사용자 ID
    private static final String DB_PASSWORD = "1234";   // 사용자 PW
    // ----------------------------

    // ★★★ 크롤링 대상 문서 ID 목록 - 여기에 직접 입력 ★★★
    private static final String[] TARGET_DOCUMENT_IDS = {
            //17년도 2건
            "8817728","8445141",

            //24년도 374건
            "24453086","24433849","24343041","24341538","24332495","24321215","24257998","24240298","24210693","24196549","24190855","24161825","24044837","24044779","24038368","24019517","24015061","24014609","24009827","24001823","24000561","23999030","23992443","23990589","23989275","23984928","23983553","23980304","23973460","23969243","23965513","23964991","23964706","23964520","23964462","23964449","23960249","23958244","23957286","23956660","23956652","23955699","23953009","23952507","23945526","23942091","23929581","23929061","23928881","23928488","23928280","23920198","23917177","23915450","23914627","23914551","23914335","23914243","23904248","23897393","23896028","23893334","23888159","23884844","23884480","23881467","23877593","23875479","23875389","23875177","23875077","23848112","23847866","23844095","23842012","23836822","23836708","23836607","23836334","23836155","23827007","23815685","23788019","23787763","23787668","23764082","23754046","23750490","23749976","23748658","23743315","23743211","23739686","23739238","23729352","23729287","23729231","23729055","23720975","23716488","23710161","23699458","23696555","23686381","23664383","23656963","23654068","23642765","23639029","23628630","23622775","23622744","23620461","23619842","23619250","23605633","23563011","23561430","23560807","23560780","23557522","23557372","23553070","23552598","23551939","23531541","23523930","23519303","23511104","23490208","23488574","23483467","23445463","23434763","23434625","23432653","23429395","23427237","23421108","23421002","23419914","23419664","23418955","23418918","23411132","23411011","23410740","23408924","23408131","23408083","23407646","23407423","23371244","23352123","23345546","23345431","23345349","23345231","23344631","23330863","23330636","23328674","23316372","23306527","23262572","23238522","23233220","23231778","23226542","23218484","23217444","23217280","23214392","23210483","23210424","23210385","23210019","23209788","23209371","23209196","23208787","23208597","23186556","23153717","23145298","23144557","23144518","23144464","23144404","23101216","23056973","23053077","23041617","23037243","23032725","23028537","23021256","23010837","23006692","23006526","23005125","22997922","22996418","22996338","22996251","22993600","22989723","22988771","22988563","22988456","22987444","22986424","22957838","22957173","22947998","22940407","22938116","22938078","22937998","22937885","22876566","22864739","22856003","22845341","22844618","22823198","22820527","22818711","22818621","22813379","22813246","22812086","22811561","22811551","22811160","22810950","22767563","22757120","22747054","22747012","22746979","22746927","22742939","22728162","22725956","22718855","22709268","22688930","22686503","22656093","22640116","22624673","22616099","22612683","22606437","22605139","22605034","22604199","22592906","22591948","22591822","22590278","22590109","22590022","22588195","22587808","22578077","22564662","22560053","22559249","22548922","22544046","22543398","22535767","22535659","22535580","22535329","22534575","22523268","22480556","22475740","22471509","22470701","22459521","22452596","22440471","22439147","22439109","22428039","22426756","22422005","22421696","22421649","22420614","22414926","22413644","22413478","22413275","22413131","22410439","22404407","22393767","22376838","22375460","22361161","22359719","22359628","22359374","22359118","22355594","22338796","22308048","22304083","22297426","22291817","22273310","22268350","22254516","22243676","22240568","22230103","22229808","22229560","22229082","22221800","22221581","22214469","22214216","22214143","22212063","22210375","22206719","22204332","22190141","22184989","22179068","22166301","22159348","22157783","22156296","22149511","22144968","22144828","22144742","22144567","22134990","22134909","22134672","22134583","22132288","22120229","22120048","22119985","22117924","22116689","22114469","22114215","22107943","22107588","22107105","22107072","22099356","22098504","22098223","22097977","22097756","22096965","22096604","22096089","22095879","22095654","22091678","22090808","22086615"

//            "26895054","26890842","26889806","26888670","26888504","26886530","26886133","26885982","26885960","26885829","26885673","26884406","26883793","26880766","26880087","26879573","26879467","26876058","26876005","26875900","26875283","26875000","26870965","26870759","26869836","26869348","26867203","26867095","26866627","26862873","26861751","26860284","26859581","26857684","26857028","26856981","26856949","26856781","26856636","26855792","26855644","26855216","26854954","26854879","26853151","26852485","26851919","26851491","26851358","26851347","26851180","26846561","26846469","26846381","26846246","26845946","26845364","26843891","26843407","26842628","26842550","26841992","26838170","26837263","26836938","26836694","26836181","26835519","26834957","26834781","26832150","26831813","26831074","26830725","26828462","26828023","26826717","26825723","26824807","26824525","26824251","26822344","26821433","26820164","26818774","26818633","26818267","26817660","26817609","26817554","26817496","26816243","26815330","26815168","26815042","26814927","26814758","26814565","26809478","26809412","26809035","26808907","26808821","26807761","26807226","26805235","26805075","26803775","26802169","26801635","26800470","26800280","26800258","26800112","26799355","26798493","26798210","26797019","26796001","26795899","26795839","26795800","26795296","26795241","26794352","26792102","26792100","26792055","26791816","26789265","26787864","26787141","26786825","26785458","26785267","26785073","26785018","26784666","26783724","26781781","26780782","26780612","26780600","26779772","26778508","26777774","26777042","26776661","26774479","26773358","26773210","26770220","26768747","26768498","26768245","26766231","26766153","26766065","26765596","26765454","26765439","26764887","26764508","26764468","26764418","26763973","26763948","26763929","26763436","26762538","26762265","26762064","26761800","26761549","26761419","26760973","26760714","26760548","26760379","26760147","26759599","26759567","26759551","26759307","26759156","26759132","26758948","26758527","26758422","26758372","26757979","26757883","26757817","26757753","26757614","26756762","26756422","26756002","26755342","26754644","26753645","26753105","26752748","26751448","26751436","26750908","26750442","26749859","26749599","26749587","26749350","26748593","26745687","26745498","26743953","26743633","26742771","26740713","26740175","26739335","26739273","26739272","26738955","26738484","26738365","26738004","26732015","26727566","26726092","26724627","26724605","26724479","26720126","26719536","26718593","26718533","26715831","26715687","26715680","26715649","26713508","26713245","26711925","26711721","26710226","26709917","26708724","26708043","26707753","26707676","26707524","26705302","26704520","26704509","26704180","26703839","26702372","26701003","26700982","26700529","26699918","26699532","26699467","26698482","26698458","26697743","26694554","26694444","26691545","26690108","26689616","26689581","26689451","26689347","26682321","26681912","26677231","26674574","26673064","26669949","26669907","26667881","26666840","26666252","26665950","26661283","26661223","26661115","26660906","26660502","26657300","26657127","26657039","26656531","26655716","26655630","26654413","26653603","26653339","26652058","26651584","26650318","26649682","26649566","26647990","26647009","26646992","26646974","26646866","26644951","26642460","26640844","26640399","26640369","26638620","26637598","26637566","26636916","26636281","26636116","26635832","26635816","26635805","26635608","26635363","26635198","26632186","26632045","26632024","26631773","26631582","26631581","26631512","26631086","26631024","26630792","26627857","26627847","26627327","26625102","26622798","26620466","26619986","26618477","26617883","26616212","26612719","26612124","26611883","26611657","26608424","26608131","26608084","26605719","26605616","26604475","26603183","26603017","26602948","26602671","26600867","26600643","26600479","26599018","26598011","26595545","26594752","26594507","26594482","26594449","26593266","26589939","26588792","26587503","26586611","26585769","26585017","26585012","26584574","26583437","26580299","26579731","26578872","26578282","26573755","26573742","26573728","26570479","26569817","26568016","26568003","26564377","26564358","26564310","26563463","26562000","26560354","26559215","26558182","26557172","26553983","26553471","26553291","26553220","26552948","26552693","26552655","26552426","26552416","26551994","26550930","26547963","26544777","26544571","26544474","26544384","26544309","26544256","26543565","26543116","26542658","26540918","26540415","26539857","26539381","26538575","26535853","26533707","26533431","26532309","26531147","26531100","26530547","26529099","26529002","26528264","26526255","26524426","26522306","26521774","26521143","26521109","26520879","26520702","26518979","26517136","26516094","26514382","26513605","26512560","26512010","26510522","26507744","26505161","26503805","26503447","26502782","26502408","26502276","26502196","26499647","26499294","26496738","26495428","26494377","26493512","26492864","26492381","26489394","26488935","26487518","26487399","26486355","26486219","26486146","26486094","26486041","26485147","26483140","26481772","26480609","26472776","26472453","26471963","26467960","26467105","26466728","26465340","26465318","26465290","26464961","26464694","26463432","26463204","26463103","26462674","26461275","26458790","26458172","26457821","26457225","26457195","26455589","26454855","26453276","26453009","26452833","26452832","26452497","26450636","26450147","26448745","26447214","26447156","26447102","26446241","26446016","26444746","26444392","26443420","26442663","26442615","26442471","26440161","26439211","26438694","26438689","26438624","26438458","26437154","26435539","26434730","26434646","26433834","26433276","26430518","26430442","26430305"
//            "26895054","26890842","26889806","26888670","26888504","26886530","26886133","26885982","26885960","26885829","26885673","26884406","26883793","26880766","26880087","26879573","26879467","26876058","26876005","26875900","26875283","26875000","26870965","26870759","26869836","26869348","26867203","26867095","26866627","26862873","26861751","26860284","26859581","26857684","26857028","26856981","26856949","26856781","26856636","26855792","26855644","26855216","26854954","26854879","26853151","26852485","26851919","26851491","26851358","26851347","26851180","26846561","26846469","26846381","26846246","26845946","26845364","26843891","26843407","26842628","26842550","26841992","26838170","26837263","26836938","26836694","26836181","26835519","26834957","26834781","26832150","26831813","26831074","26830725","26828462","26828023","26826717","26825723","26824807","26824525","26824251","26822344","26821433","26820164","26818774","26818633","26818267","26817660","26817609","26817554","26817496","26816243","26815330","26815168","26815042","26814927","26814758","26814565","26809478","26809412","26809035","26808907","26808821","26807761","26807226","26805235","26805075","26803775","26802169","26801635","26800470","26800280","26800258","26800112","26799355","26798493","26798210","26797019","26796001","26795899","26795839","26795800","26795296","26795241","26794352","26792102","26792100","26792055","26791816","26789265","26787864","26787141","26786825","26785458","26785267","26785073","26785018","26784666","26783724","26781781","26780782","26780612","26780600","26779772","26778508","26777774","26777042","26776661","26774479","26773358","26773210","26770220","26768747","26768498","26768245","26766231","26766153","26766065","26765596","26765454","26765439","26764887","26764508","26764468","26764418","26763973","26763948","26763929","26763436","26762538","26762265","26762064","26761800","26761549","26761419","26760973","26760714","26760548","26760379","26760147","26759599","26759567","26759551","26759307","26759156","26759132","26758948","26758527","26758422","26758372","26757979","26757883","26757817","26757753","26757614","26756762","26756422","26756002","26755342","26754644","26753645","26753105","26752748","26751448","26751436","26750908","26750442","26749859","26749599","26749587","26749350","26748593","26745687","26745498","26743953","26743633","26742771","26740713","26740175","26739335","26739273","26739272","26738955","26738484","26738365","26738004","26732015","26727566","26726092","26724627","26724605","26724479","26720126","26719536","26718593","26718533","26715831","26715687","26715680","26715649","26713508","26713245","26711925","26711721","26710226","26709917","26708724","26708043","26707753","26707676","26707524","26705302","26704520","26704509","26704180","26703839","26702372","26701003","26700982","26700529","26699918","26699532","26699467","26698482","26698458","26697743","26694554","26694444","26691545","26690108","26689616","26689581","26689451","26689347","26682321","26681912","26674574","26673064","26666840","26666252","26665950","26661223","26657039","26656531","26653603","26651584","26647990","26646974","26644951","26640844","26640369","26637598","26637566","26636281","26635608","26635363","26635198","26632186","26632045","26631773","26631582","26631581","26631512","26631086","26631024","26630792","26620466","26604475","26586611","26552693","26524426","26480609","26463103","26462674","26458790","26457821","26453276","26452497","26450636","26447102","26444746","26444392","26442615","26442471","26440161","26439211","26438694","26438689","26438624","26438458","26434730","26433834"
//            "26836938","26824807","26824251","26821433","26820164","26818774","26818633","26818267","26817660","26817609","26817554","26817496","26816243","26815330","26815168","26815042","26814927","26814758","26814565","26809478","26809035","26808907","26808821","26807761","26807226","26805235","26805075","26802169","26801635","26800470","26800280","26800258","26799355","26798493","26798210","26797019","26796001","26795899","26795839","26795800","26795296","26795241","26794352","26792102","26792100","26792055","26791816","26789265","26787864","26787141","26786825","26785267","26785073","26785018","26784666","26783724","26781781","26780782","26780612","26780600","26779772","26778508","26777774","26777042","26776661","26774479","26773358","26770220","26768747","26768498","26768245","26766231","26766153","26766065","26765596","26765454","26764887","26764508","26764468","26764418","26763973","26763948","26763929","26763436","26761549","26760973","26760714","26760548","26760379","26760147","26759599","26759567","26759551","26759307","26759156","26759132","26758948","26758527","26758422","26758372","26756762","26756422","26756002","26755342","26754644","26753645","26753105","26752748","26751448","26751436","26750908","26750442","26749859","26749599","26749587","26749350","26748593","26745687","26745498","26743953","26743633","26742771","26740713","26740175","26739335","26739273","26739272","26738955","26738484","26738365","26738004","26732015","26727566","26724627","26720126","26719536","26718593","26718533","26715831","26713508","26713245","26711925","26711721","26710226","26709917","26708724","26708043","26707676","26707524","26705302","26704520","26704509","26703839","26702372","26701003","26700982","26700529","26699918","26699532","26699467","26698482","26698458","26697743","26694554","26694444","26691545","26690108","26689616","26689581","26689451","26689347","26682321","26681912","26677231","26669949","26669907","26667881","26666252","26665950","26661283","26661223","26661115","26660906","26660502","26657300","26657127","26657039","26656531","26655716","26655630","26654413","26653339","26652058","26651584","26650318","26649682","26649566","26647990","26647009","26646992","26646866","26644951","26642460","26640399","26638620","26636916","26636116","26635832","26635816","26635805","26632024","26627857","26627847","26627327","26625102","26622798","26620466","26619986","26618477","26617883","26616212","26612719","26612124","26611883","26611657","26608424","26608131","26608084","26605719","26605616","26603183","26603017","26602948","26602671","26600867","26600643","26600479","26599018","26598011","26595545","26594752","26594507","26594482","26594449","26593266","26589939","26588792","26587503","26585769","26585017","26585012","26584574","26583437","26580299","26579731","26578872","26578282","26573755","26573742","26573728","26570479","26569817","26568016","26568003","26564377","26564358","26564310","26563463","26562000","26560354","26559215","26558182","26557172","26553983","26553471","26553291","26553220","26552948","26552655","26552426","26552416","26551994","26550930","26547963","26544777","26544571","26544474","26544384","26544309","26544256","26543565","26543116","26542658","26540918","26540415","26539857","26539381","26538575","26535853","26533707","26533431","26532309","26531147","26531100","26530547","26529099","26529002","26528264","26526255","26522306","26521774","26521143","26521109","26520879","26520702","26518979","26517136","26516094","26514382","26513605","26512560","26512010","26510522","26507744","26505161","26503805","26503447","26502782","26502408","26502276","26502196","26499647","26499294","26496738","26495428","26494377","26493512","26492864","26492381","26489394","26488935","26487518","26487399","26486355","26486219","26486146","26486094","26486041","26485147","26483140","26481772","26472776","26472453","26471963","26467960","26467105","26466728","26465340","26465318","26465290","26464961","26464694","26463432","26463204","26461275","26458172","26457225","26457195","26455589","26454855","26453009","26452833","26452832","26450147","26448745","26447214","26447156","26446241","26446016","26443420","26442663","26437154","26435539","26434646","26433276","26430518","26430442","26430305"
    };

    // 데이터 삽입 SQL 쿼리
    private static final String INSERT_SQL =
            "INSERT INTO approval_data_2024_17 (document_id, post_title, sequence, status, approval_date, department, approver) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?)";

    // 이미 처리된 문서 ID를 조회하는 SQL
    private static final String SELECT_PROCESSED_IDS_SQL =
            "SELECT DISTINCT document_id FROM approval_data_2024_17";

    // 상세 페이지에서 문서 제목을 추출할 XPath
    private static final String DOC_TITLE_XPATH = "//span[@class='apr_title']";



    public static void main(String[] args) {
        System.setProperty(WEB_DRIVER_ID, WEB_DRIVER_PATH);
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--remote-allow-origins=*");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-dev-shm-usage"); // Linux 환경에서 유용
        options.addArguments("--disable-gpu");          // GPU 사용 비활성화
        options.addArguments("--blink-settings=imagesEnabled=false"); // 이미지 로드 비활성화 (리소스 절약)
        // options.addArguments("--headless"); // UI 없이 실행하려면 이 옵션을 활성화하세요.

        WebDriver driver = null;
        Connection conn = null;
        List<String> documentIds = new ArrayList<>();

        try {
            // --- 0. 이미 처리된 문서 ID 조회 및 필터링 ---
            System.out.println("0단계: 이미 처리된 문서 ID 조회 시작.");
            conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);

            // 이미 처리된 문서 ID를 Set으로 조회
            Set<String> processedIds = new HashSet<>();
            try (PreparedStatement pstmt = conn.prepareStatement(SELECT_PROCESSED_IDS_SQL);
                 ResultSet rs = pstmt.executeQuery()) {
                while (rs.next()) {
                    processedIds.add(rs.getString("document_id"));
                }
            }
            System.out.println("  > 이미 처리된 문서 수: " + processedIds.size());

            // TARGET_DOCUMENT_IDS에서 아직 처리되지 않은 문서만 필터링
            for (String id : TARGET_DOCUMENT_IDS) {
                if (!processedIds.contains(id)) {
                    documentIds.add(id);
                }
            }

            if (documentIds.isEmpty()) {
                System.out.println("  > 모든 문서가 이미 처리되었습니다. 크롤링을 종료합니다.");
                return;
            }
            System.out.println("  > 처리할 문서 수: " + documentIds.size() + " (전체 " + TARGET_DOCUMENT_IDS.length + "개 중)");

            // DB 연결 해제 (재연결은 배치 작업 직전에 수행)
            if (conn != null) {
                conn.close();
                conn = null;
            }
            // ---------------------------------------------


            // 1. WebDriver 및 크롤링 환경 설정
            driver = new ChromeDriver(options);
            driver.manage().window().maximize();

            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(15));
            JavascriptExecutor js = (JavascriptExecutor) driver;

            // ---------------------------------------------
            // 2단계: 로그인 및 메뉴 클릭을 통한 게시판 진입
            // ---------------------------------------------

            System.out.println("2단계: 로그인 및 메뉴 클릭을 통한 게시판 진입 시도.");

            // 2-1. 로그인 페이지 접속
            driver.get(TARGET_URL);

            // 2-2. 로그인 처리
            driver.findElement(By.id("uid")).sendKeys(USER_ID);
            driver.findElement(By.id("pwd")).sendKeys(USER_PW);
            driver.findElement(By.className("btn_login")).click();
            System.out.println("  > 로그인 버튼 클릭 완료.");

            // 2-3. '다음에 변경하기' 팝업 닫기
            String xpathPassButton = "//button[@class='home' and @onclick='pwChangePass.pass()']";
            By passButtonSelector = By.xpath(xpathPassButton);
            WebElement passButton = wait.until(ExpectedConditions.elementToBeClickable(passButtonSelector));
            passButton.click();
            System.out.println("  > '다음에 변경하기' 팝업 닫기 완료.");

            // Iframe 전환: 메뉴가 Iframe 내부에 있으므로 클릭 전에 전환합니다.
            driver.switchTo().defaultContent();
            wait.until(ExpectedConditions.frameToBeAvailableAndSwitchToIt(IFRAME_NAME));
            System.out.println("  > 메뉴 클릭을 위해 Iframe [" + IFRAME_NAME + "]으로 전환 성공.");

            // 2-4. '전자결재' 아이콘 클릭 (메뉴 로드)
            System.out.println("  > '전자결재' 아이콘 클릭 시도...");
            By aprLinkSelector = By.xpath("//a[contains(@href, '/apr/') and contains(@class, 'left_menu')]");
            WebElement aprLink = wait.until(ExpectedConditions.elementToBeClickable(aprLinkSelector));
            js.executeScript("arguments[0].click();", aprLink); // JS 강제 클릭
            Thread.sleep(1000); // 메뉴 로드 대기
            System.out.println("  > '전자결재' 아이콘 클릭 완료.");

            // 2-5. '결재문서관리' 메뉴 클릭 (managementDoc 로드)
            System.out.println("  > '결재문서관리' 메뉴 클릭 시도...");
            By docLiSelector = By.xpath("//li[contains(@onclick, 'managementDoc')]");
            WebElement managementDocLi = wait.until(ExpectedConditions.elementToBeClickable(docLiSelector));
            js.executeScript("arguments[0].click();", managementDocLi); // JS 강제 클릭

            // managementDocList 객체가 정의될 때까지 명시적으로 기다림
            System.out.println("  > JavaScript 객체 로딩 대기 중...");
//            wait.until(driver -> (Boolean) js.executeScript("return typeof managementDocList !== 'undefined'"));
            System.out.println("  > 'managementDocList' 객체 로드 확인됨.");

            System.out.println("  > '결재문서관리' 메뉴 클릭 완료.");

            // ---------------------------------------------
            // 3단계: 건별 데이터 추출 루프
            // ---------------------------------------------

            // DB 연결 설정 (배치 작업 직전에 재연결)
            conn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            conn.setAutoCommit(false);
            System.out.println("3단계: DB 재연결 성공 (건별 삽입 준비).");

            PreparedStatement pstmt = conn.prepareStatement(INSERT_SQL);
            int totalInsertedRows = 0;

            // 추출한 ID 목록을 순회하며 크롤링 시작
            for (String postId : documentIds) {
                String postTitle = "[제목 추출 실패]";
                int currentPostRows = 0; // 현재 문서에서 추출된 행 수

                try {
                    System.out.println("\n  > 문서 ID: " + postId + " 처리 중...");

                    // 3-1. JS 함수 호출로 상세 페이지 로드 (Iframe 내에서 실행)
                    driver.switchTo().defaultContent();
                    wait.until(ExpectedConditions.frameToBeAvailableAndSwitchToIt(IFRAME_NAME));
                    Thread.sleep(2000);

                    String clickFunctionCall = String.format("managementDocList.clickGridRow(%s);", postId);
                    js.executeScript(clickFunctionCall);
                    Thread.sleep(2000);
                    System.out.println("  > JS 함수 호출 성공: " + clickFunctionCall);


                    // ★★★ 문서 ID 검증 로직 ★★★
                    final String expectedPostId = postId;
                    boolean idMatched = wait.until(driver1 -> {
                        try {
                            WebElement seqInput = driver1.findElement(
                                    By.cssSelector("input[name='appr_doc_seq']"));
                            String loadedId = seqInput.getAttribute("value");
                            return expectedPostId.equals(loadedId);
                        } catch (Exception e) {
                            return false;
                        }
                    });

                    if (!idMatched) {
                        System.err.println("    > 문서 ID 불일치, 스킵: " + postId);
                        driver.navigate().back();
                        Thread.sleep(1500);
                        continue;
                    }
                    System.out.println("    > 문서 ID 검증 성공: " + postId);
                    // 3-2. 상세 페이지 로드 대기 (Iframe 내용이 갱신되기를 기다림)
                    By tableSelector = By.id("apprLineTable");
                    WebElement apprLineTable = wait.until(ExpectedConditions.presenceOfElementLocated(tableSelector));
                    Thread.sleep(2000);

                    // 3-3. 문서 제목 추출
                    try {
                        WebElement titleElement = driver.findElement(By.xpath(DOC_TITLE_XPATH));
                        postTitle = titleElement.getText().trim();
                    } catch (Exception titleEx) {
                        System.err.println("  > 경고: 제목 추출 실패, 기본값 사용. 오류: " + titleEx.getMessage());
                    }

                    System.out.println("  > 결재 라인 테이블 로드 확인. (제목: " + postTitle + ")");

                    // 3-4. 결재 라인 테이블 찾기 및 데이터 추출
                    List<WebElement> rows = apprLineTable.findElements(By.tagName("tr"));

                    for (int i = 1; i < rows.size(); i++) {
                        WebElement row = rows.get(i);
                        List<WebElement> cells = row.findElements(By.tagName("td"));

                        // 데이터 추출
                        String sequence = cells.get(0).getText().trim();
                        String status = cells.get(2).getText().trim().replace("\n", " ");
                        String approvalDate = cells.get(3).getText().trim();
                        String department = cells.get(4).getText().trim();
                        String approver = cells.get(5).findElement(By.tagName("a")).getText().trim();

                        // 3-5. DB 배치에 추가
                        pstmt.setString(1, postId);
                        pstmt.setString(2, postTitle);
                        pstmt.setString(3, sequence);
                        pstmt.setString(4, status);
                        pstmt.setString(5, approvalDate);
                        pstmt.setString(6, department);
                        pstmt.setString(7, approver);

                        pstmt.addBatch();
                        totalInsertedRows++;
                        currentPostRows++;
                    }

                    // ★★★ 수정: 문서 처리 완료 후 즉시 배치 실행 및 커밋 (메모리 최적화) ★★★
                    if (currentPostRows > 0) {
                        pstmt.executeBatch(); // 배치 실행
                        conn.commit();        // 커밋
                        System.out.println("  > 배치 실행 및 커밋 완료. (" + currentPostRows + " rows inserted for " + postId + ")");
                    }
                    // ★★★ 수정 끝 ★★★

                    // 3-6. 목록 페이지로 복귀 (Iframe 내에서 작동)
                    driver.navigate().back();
                    System.out.println("  > 목록 페이지로 복귀.");

                    // 복귀 후, Iframe 콘텐츠가 다시 목록 뷰로 갱신되기를 기다립니다.
                    wait.until(ExpectedConditions.invisibilityOfElementLocated(By.id("apprLineTable")));
                    System.out.println("  > Iframe 콘텐츠 갱신 확인 완료.");

                } catch (Exception processEx) {
                    System.err.println("  > 오류: 문서 처리 실패 (" + postId + "): " + processEx.getMessage());

                    // 오류 발생 시, 안전하게 목록 페이지로 복귀 시도
                    driver.navigate().back();
                    try {
                        // Iframe이 깨졌을 경우를 대비해 다시 전환 시도
                        driver.switchTo().defaultContent();
                        wait.until(ExpectedConditions.frameToBeAvailableAndSwitchToIt(IFRAME_NAME));
                    } catch (Exception recoveryEx) {
                        System.err.println("  > 경고: 목록 복귀 중 치명적인 오류 발생. 루프 종료.");
                        break;
                    }
                }
            } // for loop 종료

            // ---------------------------------------------
            // 4단계: 최종 처리 확인 (이전의 대규모 배치 실행 코드는 제거되었습니다.)
            // ---------------------------------------------
            System.out.println("\n4단계: 모든 DB 작업이 완료되었습니다.");
            System.out.println("  > 총 " + totalInsertedRows + "개 행 DB에 삽입 완료.");

        } catch (SQLException e) {
            System.err.println("  > [DB 오류] 데이터베이스 작업 중 오류 발생: " + e.getMessage());
            try {
                if (conn != null) conn.rollback();
            } catch (SQLException rollbackEx) {
                System.err.println("  > 롤백 실패: " + rollbackEx.getMessage());
            }
            e.printStackTrace();
        } catch (Exception e) {
            System.err.println("크롤링 중 오류 발생: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // 5. 자원 해제
            try {
                if (conn != null) conn.close();
            } catch (SQLException e) {
                System.err.println("DB 연결 해제 실패: " + e.getMessage());
            }
            if (driver != null) {
                // driver.quit();
                System.out.println("WebDriver 종료.");
            }
        }
    }
}